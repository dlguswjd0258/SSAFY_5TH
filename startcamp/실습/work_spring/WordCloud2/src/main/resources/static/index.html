<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>SSAFY 5기 스타트캠프</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="img/favicon.ico" />
<!-- bootstrap을 위한 js & css 등록 -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- data 시각화 (wordcloud) -->
<script src="js/jqcloud.min.js"></script>
<link rel="stylesheet" href="js/jqcloud.min.css" />
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
<!-- data 시각화 (wordcloud) -->
<script type="text/javascript" src="js/httpRequest.js"></script>
<script type="text/javascript">
      let httpRequest;
      let myChart;
      let chart_type = "bar";
      let word_list;
      let ctx;
      let label = [];
      let data = [];
      
      window.onload = function () {
        httpRequest = sendRequest("http://localhost:9999/startcamp/word", null, getWordCloud, "GET");
      };

      function getWordCloud() {
        if (httpRequest.readyState == 4) {
          if (httpRequest.status == 200) {
            word_list = [];
            let txt = httpRequest.responseText;
            let datas = JSON.parse(txt);
            datas.forEach((data) => {
              let wc = new Object();
              wc.text = data.text;
              wc.weight = data.weight;
              wc.link = "javascript:updateCount('" + data.text + "');";
              word_list.push(wc);
            });
            $("#comments").empty();
            $("#comments").jQCloud(word_list, {
              autoResize: true,
              delay: 50
            });
            
            makeChart(word_list);
            makeConcern(word_list);
            makeSelectConcern(word_list);
          }
        }
      }

      function updateCount(word) {
        httpRequest = sendRequest(`http://localhost:9999/startcamp/word/${word}`, null, null, "POST");
      }

      function makeChart(datas) {
        datas.sort((a, b) => parseFloat(b.weight) - parseFloat(a.weight));
        
        for (let i = 0; i < 6; i++) {
          label.push(datas[i].text);
          data.push(datas[i].weight.toFixed(2));
        }
        ctx = document.getElementById("myChart").getContext("2d");
        myChart = new Chart(ctx, {
          type: chart_type,
          data: {
            labels: label,
            datasets: [
              {
                label: "# of Votes",
                data: data,
                backgroundColor: [
                  "rgba(255, 99, 132, 0.2)",
                  "rgba(54, 162, 235, 0.2)",
                  "rgba(255, 206, 86, 0.2)",
                  "rgba(75, 192, 192, 0.2)",
                  "rgba(153, 102, 255, 0.2)",
                  "rgba(255, 159, 64, 0.2)"
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",
                  "rgba(54, 162, 235, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(153, 102, 255, 1)",
                  "rgba(255, 159, 64, 1)"
                ],
                borderWidth: 1
              }
            ]
          },
          options: {
            scales: {
              yAxes: [
                {
                  ticks: {
                    beginAtZero: true
                  }
                }
              ]
            }
          }
        });
      }

      function makeConcern(datas) {
    	datas.sort(function(a,b){ // 오름차순
    		// 대문자 소문자 상관없이 오름차순으로 하기 위해 모두 대문자로 두고 계산 ( 한글은 무관 ) 
    		return a.text.toUpperCase() < b.text.toUpperCase() ? -1 : a.text.toUpperCase() > b.text.toUpperCase() ? 1: 0;
    	});
        let concern = `<table>`;
        
        for(var i = 0; i<datas.length;){
        	concern += `<tr>
        	<td  style="padding-right: 100px; padding-bottom: 5px">
              <div class="form-check">
                <label class="form-check-label">
                  <input type="checkbox" name="concern" class="form-check-input" value="${datas[i].text}">${datas[i++].text}
                </label>
              </div>
            </td>`;
            if(i>=datas.length){
	            concern += `</tr>`;
            	break;
            }
            	
            concern += `
            <td style="padding-bottom: 5px">
	          <div class="form-check">
	            <label class="form-check-label">
	              <input type="checkbox" name="concern" class="form-check-input" value="${datas[i].text}">${datas[i++].text}
	            </label>
	          </div>
	        </td>	
            </tr>`;
        }
        
        concern += `</table>`;
        document.getElementById("concernDiv").innerHTML = concern;
      }
      
      function makeSelectConcern(datas) {
      	datas.sort(function(a,b){ // 오름차순
      		// 대문자 소문자 상관없이 오름차순으로 하기 위해 모두 대문자로 두고 계산 ( 한글은 무관 ) 
      		return a.text.toUpperCase() < b.text.toUpperCase() ? -1 : a.text.toUpperCase() > b.text.toUpperCase() ? 1: 0;
      	});
      	
         let concern1 = `<select id="concern1">`;
          let concern2 = `<select id="concern2">`;
          
          datas.forEach(data => {
        	  concern1 += `<option value="${data.weight}">${data.text}</option>`;
        	  concern2 += `<option value="${data.weight}">${data.text}</option>`;
          });
          
          concern1 += `</select>`;
          concern2 += `</select>`;
          
          document.getElementById("selectConcern1").innerHTML = concern1;
          document.getElementById("selectConcern2").innerHTML = concern2;
        }

      function sendConcern() {
        let concerns = [];
        let checks = document.getElementsByName("concern");
        checks.forEach(ck => {
          if(ck.checked == true) {
            concerns.push(ck.value);
          }
        });
        let data = {"concerns" : concerns};
        console.log(data);
        $.ajax({
          url: "http://localhost:9999/startcamp/word",
          type: "post",
          data: data
        });
        // sendRequest(`http://localhost:9999/startcamp/word`, data, null, "POST");
        document.location.reload(); // 부모창 새로고침.
        $("#concernModal").modal("hide"); // 모달창 닫기.
      }
      
      function chageChart(select_box) {
    	// 그려져있던 그래프 지우기
    	clearChart();
    	  
    	// 우선 selectbox에서 선택된 index를 찾고
		var selected_index= select_box.selectedIndex;
        // 선택된 index의 value를 찾고 
        chart_type = select_box.options[selected_index].value;
        
        //그래프 다시 그리기
        makeChart(word_list);
        
	}
      
    function clearChart() {
		label = [];
        data = [];
        myChart.update();
        myChart.destroy();
		ctx.disabled = false;
	}
    
    function diffConcerns() {
    	
		var select1 = document.getElementById("concern1");
		var select2 = document.getElementById("concern2");
		
		var select1_index = select1.selectedIndex;
		var select2_index = select2.selectedIndex;
		
		var option1 = select1.options[select1_index];
		var option2 = select2.options[select2_index];
		
		var diff = Number.parseFloat(option1.value) - Number.parseFloat(option2.value);
		
		var res =`<h5>`; 
		if(diff*10 > 0){
			res += option1.text+`가 ` + option2.text + `보다 ` + diff.toFixed(1) + `만큼 큽니다.`;	
		}else if(diff*10 < 0){
			res += option2.text+`가 ` + option1.text + `보다 ` + (diff*-1).toFixed(1) + `만큼 큽니다.`;	
		} else{
			res += option1.text+`와 ` + option2.text + `은(는) 같습니다.`;	
		}
		
		res += `</h5>`;
		document.getElementById("diffResult").innerHTML = res;
		
	}
    
    function sendConcernOne() {
		var input = document.getElementById("concernOne").value;

		let concerns = [];
        concerns.push(input);
		let data = {"concerns" : concerns};
		console.log(input);
		
        $.ajax({
          url: "http://localhost:9999/startcamp/word",
          type: "post",
          data: data
        });
        
        document.location.reload(); // 새로고침.
	}
    </script>
</head>
<body>
	<!-- 상단 Header Start  -->
	<nav class="navbar navbar-expand-sm bg-light fixed-top shadow">
		<div class="container">
			<a class="navbar-brand">SSAFY 5기 스타트캠프</a>
			<button
				class="navbar-toggler navbar-toggler-right bg-secondary text-white"
				type="button" data-toggle="collapse" data-target="#navb">
				<span class="navbar-toggler-icon">-</span>
			</button>
			<div id="navb" class="collapse navbar-collapse">
				<ul class="navbar-nav mr-auto">
					<li class="nav-item"><a class="nav-link text-secondary"
						href="#">공지사항</a></li>
				</ul>
				<ul id="header_nav_confirm_off"
					class="navbar-nav justify-content-end">
					<li class="nav-item"><a class="nav-link text-secondary"
						href="#" onclick="javascript:login();">로그인</a></li>
					<li class="nav-item"><a class="nav-link text-secondary"
						href="#">회원가입</a></li>
				</ul>
				<ul id="header_nav_confirm_on"
					class="navbar-nav justify-content-end" style="display: none">
					<li class="nav-item"><a class="nav-link text-secondary"
						href="#" onclick="javascript:logout();">로그아웃</a></li>
					<li class="nav-item"><a class="nav-link text-secondary"
						href="#">마이페이지</a></li>
					<li class="nav-item dropdown"><a
						class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">관리자</a>
						<div class="dropdown-menu">
							<a class="dropdown-item" href="#voteModal" data-toggle="modal">투표만들기</a>
							<a class="dropdown-item" href="chart.html">통계보기</a> <a
								class="dropdown-item" href="#">회원관리</a>
						</div></li>
				</ul>
			</div>
		</div>
	</nav>
	<!-- 상단 Header End  -->

	<div class="container">
		<div style="height: 60px"></div>
		<!-- 중앙 contents start -->
		<div class="row text-center mt-5">
			<div class="col-md-12">
				<h2>싸피5기의 관심사</h2>
			</div>
		</div>
		<div class="row mt-3">
			<div class="col-md-6">
				<select name="chart" id="chart" onchange="chageChart(this)">
					<option value="bar">bar</option>
					<option value="line">line</option>
					<option value="polarArea">polar area</option>
					<option value="doughnut">doughnut</option>
				</select>
				<canvas id="myChart" width="400" height="300"></canvas>
			</div>
			<div class="col-md-6">
				<h3>
					WordCloud
					<button class="btn btn-outline-primary"
						onclick="location.reload();">새로고침</button>
					<a class="btn btn-outline-primary" href="#concernModal"
						data-toggle="modal">여러관심사등록</a>
				</h3>
				
				<input id="concernOne" style="margin:10px 0;">
				<button class="btn btn-outline-primary"
						onclick="sendConcernOne()">등록</button>
				<div id="comments"
					style="width: 550px; height: 350px; border: 1px solid #ccc"></div>
			</div>
		</div>

		<!-- 두 관심사 비교 start -->
		<div style="margin-top: 30px">
			<h3>관심사 비교</h3>
			<p style="display: inline-block; margin-right: 20px;">차이를 비교하고 싶은
				두 관심사를 선택하세요.</p>
			<div id="selectConcern1"
				style="display: inline-block; margin-right: 10px;"></div>

			<div id="selectConcern2"
				style="display: inline-block; margin-right: 10px;"></div>

			<button style="padding: 6px; font-size: 15px; text-align: center;"
				type="button" class="btn btn-outline-primary"
				onclick="diffConcerns()">확인</button>

			<div id="diffResult"></div>
		</div>
	</div>
	<!-- 중앙 contents end -->

	<!-- 하단 Footer Start  -->
	<footer class="navbar navbar-expand-md justify-content-end">
		<div class="row">
			<div class="col-md-12">
				<ul class="navbar-nav">
					<li><a class="nav-link text-secondary" href="#">카페소개</a></li>
					<li><a class="nav-link text-secondary" href="#">개인정보처리방침</a></li>
					<li><a class="nav-link text-secondary" href="#">이용약관</a></li>
					<li><a class="nav-link text-secondary" href="#">오시는길</a></li>
					<li><label class="nav-link text-secondary">&copy;
							SSAFY Corp.</label></li>
				</ul>
			</div>
		</div>
	</footer>
	<!-- 하단 Footer End  -->

	<!-- 관심사 등록 modal start -->
	<div id="concernModal" class="modal fade">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">5기 여러분 관심사를 체크해주세요!!!</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<div id="concernDiv"></div>
					<div class="form-group mt-2 text-right">
						<button type="button" id="pollMakeBtn" class="btn btn-primary"
							onclick="javascript:sendConcern();">관심사전송</button>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- 관심사 등록 modal end -->

</body>
</html>
